---
title: "HW7_anova and INLA"
author: "N. Barrus"
date: "2024-03-05"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Purpose:

The purpose of this markdown document is to work through Homework 7 in Dr. Babcock's Bayesian Statistics Course at the University of Miami. Homework 7 deals with ANOVA and INLA  

## General Start to Code

```{r}

rm(list = ls())

######github#####
#note, only needed after 90 days from 1/16/2024

#  usethis::create_github_token()  
#  gitcreds::gitcreds_set()

#####check for r updates#####
#note, updateing may take some time so plan accordingly

#require(installr)

#check.for.updates.R()

#updateR() #only if needed

#######check for package updates#####
#note, updateing may take some time so plan accordingly

#old.packages()

# update.packages() #make the decision to the update the packages

```
  
## Load packages

```{r, results='hide'}
library(INLAutils)
library(INLA)
library(tidyverse)
library(R2jags)
library(rstan)
library(ggmcmc)
library(purrr)
library(magrittr)
library(here)
library(loo)
library(DHARMa)
theme_set(theme_bw(base_size=15))
options(mc.cores = parallel::detectCores())
rstan_options(auto_write = TRUE)
```

## Data  

The moth data will be used in the problem 1, and it contains three variables (Moth, Location, Bait). Moth is the number of spruce moths caught in a trap in 48 hours, Location is the location of the trap in the trees (Ground, Lower, Middle, Top), and Bait is the bait used (Chemical, Scent, Sugar).  

The football data is the weight in lbs of randomly selected football players from randomly selected teams (coded as 1 to 5).  

```{r}

###problem 1 data

moth.data <- read_csv(here("data","moth.csv")) |> 
  mutate(LocationNum = as.numeric(as.factor(Location)),
         BaitNum = as.numeric(as.factor(Bait)))

head(moth.data)

###problem 2 data

football.data <- read_csv(here("data","football.csv"))

head(football.data)

```

## Problem 1: Fixed effects 2-way ANOVA JAGS  


#### A) Fit an ANOVA model in JAGS to predict number of moths caught (y) as a function of the categorical (x) variables LocationNum and BaitNum. Do not include an interaction. Assume the error is normally distributed and all the factors are fixed effects. Use Chemical and Ground as the reference levels and estimate the differences from that reference level for the other levels of each factor. Use uninformative priors. Give the summary statistics. Which coefficients appear to be different from zero based on their credible intervals?  

table of contrasts  
-----------------------BAIT Period-----------------------------------    
-----------------1---------------2--------------------3--------------    
Location 1 --ref------------ref+Bait[2]-----------ref+Bait[3]--------   
Location 2 --ref+loc[2]-----ref+loc[2]+Bait[2]----ref+Loc[2]+Bait[3]-  
Location 3 --ref+loc[3]-----ref+loc[3]+Bait[2]----ref+Loc[3]+Bait[3]-  
Location 4 --ref+loc[4]-----ref+loc[4]+Bait[2]----ref+Loc[4]+Bait[3]-   

*set up and run JAGS model*  

```{r}

write("model   
{  # two-way ANOVA without interaction term, using reference classes

  #set up contrast priors
  
  base ~ dnorm(0, 1.0E-6)
  a[1] <- 0   #reference location
  a[2] ~ dnorm(0.0, 1.0E-6)
  a[3] ~ dnorm(0.0, 1.0E-6)
  a[4] ~ dnorm(0.0, 1.0E-6) 
  b[1] <- 0   #refernce bait
  b[2] ~ dnorm(0.0, 1.0E-6)
  b[3] ~ dnorm(0.0, 1.0E-6)

  tau ~ dgamma(0.001, 0.001)  # uninformative precision

  for (i in 1:N) # for each of the samples
  {
    ymean[i] <- base + a[X1[i]] + b[X2[i]] 
    Y[i] ~ dnorm(ymean[i], tau)
    LL[i] <- -0.5*log(2*3.14159)+0.5*log(tau)-0.5*tau*(Y[i]-ymean[i])*(Y[i]-ymean[i])
  }
}
",file=here("JAGS_mods","HW7-1A-ANOVA-2way-noint.txt"))

moth.list <- list(Y = moth.data$Moths,
                  X1 = moth.data$LocationNum,
                  X2 = moth.data$BaitNum,
                  N = length(moth.data$Moths))

jags.anova.2way.noint <-jags(data = moth.list,
  model.file=here("JAGS_mods","HW7-1A-ANOVA-2way-noint.txt"),
  parameters.to.save=c("base","a","b","tau","LL"),n.chains=2,n.iter=110000,n.burnin=10000,n.thin=10)


```
  *output summary*
  
```{r}
round(jags.anova.2way.noint$BUGSoutput$summary,2)
```


#### B) Now add the 2-way interaction between location and bait to your model. Give the summary statistics. Which coefficients appear to be different from zero based on their credible intervals?  


table of contrasts  
--------------------------------------BAIT Period--------------------------------------    
-----------------1----------------------2----------------------------3-----------------    
Location 1 --ref--------------------ref+Bait[2]------------------ref+Bait[3]-----------   
Location 2 --ref+loc[2]-----ref+loc[2]+Bait[2]+int[2,2]----ref+Loc[2]+Bait[3]+int[2,3]-  
Location 3 --ref+loc[3]-----ref+loc[3]+Bait[2]+int[3,2]----ref+Loc[3]+Bait[3]+int[3,3]-  
Location 4 --ref+loc[4]-----ref+loc[4]+Bait[2]+int[4,2]----ref+Loc[4]+Bait[3]+int[4,3]-  

*set up and run JAGS model*  

```{r}

write("model   
{ #two-way ANOVA with interaction term, using reference classes

  #set up contrast priors- noninteractions
  base ~ dnorm(0, 1.0E-6)
  a[1] <- 0   #reference location
  a[2] ~ dnorm(0.0, 1.0E-6)
  a[3] ~ dnorm(0.0, 1.0E-6)
  a[4] ~ dnorm(0.0, 1.0E-6) 
  b[1] <- 0   #reference bait
  b[2] ~ dnorm(0.0, 1.0E-6)
  b[3] ~ dnorm(0.0, 1.0E-6)
  
  #set up contrast priors- interactions
  int[1,1] <- 0
  int[2,1] <- 0
  int[3,1] <- 0
  int[4,1] <- 0
  int[1,2] <- 0
  int[2,2] ~ dnorm(0.0, 1.0E-6)
  int[3,2] ~ dnorm(0.0, 1.0E-6)
  int[4,2] ~ dnorm(0.0, 1.0E-6)
  int[1,3] <- 0
  int[2,3] ~ dnorm(0.0, 1.0E-6)
  int[3,3] ~ dnorm(0.0, 1.0E-6)
  int[4,3] ~ dnorm(0.0, 1.0E-6)

  tau ~ dgamma(0.001, 0.001)  # uninformative precision

#model

  for (i in 1:N) # for each of the samples
  {
    ymean[i] <- base + a[X1[i]] + b[X2[i]] + int[X1[i],X2[i]]
    Y[i] ~ dnorm(ymean[i], tau)
    LL[i] <- -0.5*log(2*3.14159)+0.5*log(tau)-0.5*tau*(Y[i]-ymean[i])*(Y[i]-ymean[i])
  }
}
",file=here("JAGS_mods","HW7-1B-ANOVA-2way-int.txt"))

moth.list <- list(Y = moth.data$Moths,
                  X1 = moth.data$LocationNum,
                  X2 = moth.data$BaitNum,
                  N = length(moth.data$Moths))

jags.anova.2way.int <-jags(data = moth.list,
  model.file=here("JAGS_mods","HW7-1B-ANOVA-2way-int.txt"),
  parameters.to.save=c("base","a","b","int","tau","LL"),n.chains=2,n.iter=110000,n.burnin=10000,n.thin=10)


``` 

  *output summary*
  
```{r}
round(jags.anova.2way.int$BUGSoutput$summary,2)
```
  
  
#### C) Calculate the delta-WAIC. Which of these two models is best?  Is that consistent with what you would expect from looking at the credible intervals of the parameter estimates?   

```{r}
LLs <- paste0("LL[",1:moth.list$N,"]")

WAIC.table <- tibble(model = c("2way-Anova-noint", "2way-Anova-int"),
                    model.ls = c(list(jags.anova.2way.noint), list(jags.anova.2way.int)),
                    LL.ls = c(list(jags.anova.2way.noint$BUGSoutput$sims.matrix[,LLs]),
                            list(jags.anova.2way.int$BUGSoutput$sims.matrix[,LLs]))) |> 
  mutate(WAIC.ls = map(LL.ls, waic),
         elpd_waic = map_dbl(WAIC.ls,c(1,1)),
         p_waic = map_dbl(WAIC.ls,c(1,2)),
         waic = map_dbl(WAIC.ls,c(1,3)),
         deltaWAIC = waic - min(waic),
         weight = round(exp(-2*deltaWAIC)/sum(exp(-2*deltaWAIC)),digits = 5))

WAIC.table |> select(-model.ls,-LL.ls,-WAIC.ls) |> knitr::kable(caption = "WAIC Table")
```


## Problem 2: Mixed effects/ heirarchical models in JAGS or STAN


#### A) Treating team as a random effect, estimate the mean for each team, the grand mean, the standard deviation between teams and the standard deviation within teams (i.e. error sd). Assume the data are normally distributed. Assume the within group variance is the same for all groups. Use an exponential prior for the standard deviations. Show the summary statistics for all the parameters and use ggs_caterpillar to compare the means across teams.  

*write and run the model*

```{r}

write("model{
    #set up random effects
    a ~ dnorm(0, 1.0E-6)
    
    #deviations from 
    for (i in 1:5) {
    d[i] ~ dnorm(0, 1.0E-6)
    }
    
    sd_among ~ dunif(0,100)
    
    tau_a <- 1/(sd_among*sd_among)

      }", file = here("JAGS_mods","jags_2a_me.txt"))


```


#### B) Compare the CIs of the standard deviations within and between groups. Based on these results, do you think the location random effect is necessary in this model?  



#### C) Now run the model without the location random effect, with only the grand mean (i.e a null model).  Show the WAIC values for the models in part a and part c.  Does the WAIC support including the random effect in the model?  



#### D) When, if ever, would it make sense to model team as a fixed effect rather than a random effect? Explain your reasoning.  


## Problem 3: INLA   


#### A) Repeat the moth models from part 1 in INLA along with a 3rd model with location only, using default priors, and print the results with summary and autoplot.  Do you get similar coefficients to part 1 for the same models?  


#### B) Calculate DIC and WAIC for all 3 models. Which model is preferred?  


#### C)	Plot the residuals vs. fitted values and qqnormal of the residuals from the WAIC best model for the moth data. Does the normal model seem to fit adequately?  


#### D) Repeat the football models from part 2a and c in INLA, using default priors, and print the results with summary and autoplot.  What did you get for the WAIC values and was the deltaWAIC result the same?   




```{r, eval=FALSE, include=FALSE}
rmarkdown::render(input = here("scripts","HW7_ANOVA-ME-INLA.Rmd"),
                  output_file = here("renders","HW7_ANOVA-ME-INLA.pdf"),
                  output_format = "pdf_document")
```